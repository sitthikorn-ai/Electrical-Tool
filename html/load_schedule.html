<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>ตารางรายการโหลด</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Leelawadee UI', 'Microsoft Sans Serif', sans-serif;
            font-size: 10px;
            background: #fff;
            color: #000;
            padding: 8px;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
        }

        .main-table td,
        .main-table th {
            border: 1px solid #000;
            padding: 2px 4px;
            vertical-align: middle;
            font-size: 10px;
        }

        .title-row td {
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            padding: 4px;
        }

        .header-info td {
            font-size: 10px;
            padding: 2px 6px;
        }

        .header-info .label {
            font-weight: normal;
            white-space: nowrap;
        }

        .header-info input {
            border: none;
            border-bottom: 1px dotted #999;
            background: transparent;
            font-family: inherit;
            font-size: 10px;
            outline: none;
            width: 100%;
            padding: 1px 2px;
        }

        .header-info input:focus {
            border-bottom: 1px solid #0066d6;
            background: #f0f7ff;
        }

        .circuit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .circuit-table th,
        .circuit-table td {
            border: 1px solid #000;
            padding: 1px 3px;
            text-align: center;
            font-size: 9px;
            vertical-align: middle;
            height: 24px;
        }

        .circuit-table th {
            background-color: #fff;
            font-weight: bold;
            font-size: 9px;
        }

        .circuit-table .sub-header th {
            font-weight: normal;
            font-size: 8.5px;
        }

        .circuit-table td.la {
            text-align: left;
            padding-left: 4px;
        }

        .sld-cell {
            padding: 0 !important;
            vertical-align: top !important;
        }

        .footer-row td {
            font-weight: bold;
        }

        .toolbar {
            margin-bottom: 6px;
            display: flex;
            gap: 6px;
        }

        .toolbar button {
            padding: 4px 10px;
            font-size: 11px;
            border: 1px solid #999;
            background: #f0f0f0;
            cursor: pointer;
            font-family: inherit;
            border-radius: 2px;
        }

        .toolbar button:hover {
            background: #e0e0e0;
        }

        @media print {
            .toolbar {
                display: none;
            }

            body {
                padding: 0;
            }
        }

        .clickable {
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }

        .clickable:hover {
            color: #0066d6 !important;
        }

        .clickable.selected {
            background: #d0e8ff;
            outline: 2px solid #0066d6;
            outline-offset: -2px;
            border-radius: 2px;
        }

        .calc-row td {
            background: #f0f4ff;
            padding: 3px 6px;
            font-size: 10px;
        }

        .calc-row select {
            border: 1px solid #888;
            background: #fff;
            font-family: inherit;
            font-size: 10px;
            padding: 2px 4px;
            width: 100%;
            border-radius: 2px;
            cursor: pointer;
        }

        .calc-row select:focus {
            border-color: #0066d6;
            outline: none;
        }

        .calc-row .calc-result {
            font-weight: bold;
            color: #c00;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 10px;
            width: 100%;
            padding: 1px 2px;
        }
    </style>
</head>

<body>

    <div class="toolbar">
        <button onclick="requestData()">โหลดข้อมูลใหม่</button>
        <button onclick="exportToCSV()">ส่งออก CSV</button>
        <button onclick="window.print()">พิมพ์</button>
    </div>

    <table class="main-table" id="mainTable">
        <!-- ===== Title ===== -->
        <tr class="title-row">
            <td colspan="30">ตารางรายการโหลด</td>
        </tr>

        <!-- ===== Header Row 1 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">เลขที่แผงย่อย</span></td>
            <td colspan="5"><input type="text" id="panelName" value="LC1"></td>
            <td colspan="4"><span class="label">เบรกเกอร์วงจรย่อย</span></td>
            <td colspan="7"><input type="text" id="subBreakerRating" value="IC. > 6 KA. at 240 V.ac., 415 V.ac."></td>
            <td colspan="4"><span class="label">สถานที่ติดตั้ง</span></td>
            <td colspan="3"><span class="label">ตามแบบ</span></td>
            <td colspan="3"><input type="text" id="drawingRef" value=""></td>
        </tr>
        <!-- ===== Header Row 2 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">ระบบไฟฟ้า</span></td>
            <td colspan="5"><input type="text" id="systemType" value="3 Ø 4 WIRE WITH GROUND 380/220 V.ac. 50 Hz"></td>
            <td colspan="4"><span class="label">จำนวนวงจรสูงสุด</span></td>
            <td colspan="7"><input type="text" id="maxCircuits" value="18 วงจร"></td>
            <td colspan="4"><span class="label">พิกัดกระแสบาร์</span></td>
            <td colspan="3"><input type="text" id="busbarRating" value="> 100 A."></td>
            <td colspan="3"><span class="label">เลขที่แบบ</span> <input type="text" id="drawingNo" value="-"
                    style="width:50px;"></td>
        </tr>
        <!-- ===== Header Row 3 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">ระดับป้องกัน</span></td>
            <td colspan="5"><input type="text" id="protectionLevel" value="NEMA TYPE 1"></td>
            <td colspan="21"></td>
        </tr>

        <!-- ===== Circuit Table ===== -->
        <tr>
            <td colspan="30" style="padding:0; border:none;">
                <table class="circuit-table" id="circuitTable">
                    <thead>
                        <tr>
                            <!-- LEFT 9 cols -->
                            <th rowspan="2" style="width:90px;">รายการ</th>
                            <th colspan="2">สายไฟ</th>
                            <th rowspan="2" style="width:50px;">ท่อ<br>(ø IN)</th>
                            <th colspan="2">เบรกเกอร์</th>
                            <th colspan="3">เลขที่</th>
                            <!-- CENTER 1 col -->
                            <th rowspan="2" style="width:130px;">ไดอะแกรม</th>
                            <!-- RIGHT 10 cols -->
                            <th rowspan="2" style="width:30px;">เลขที่</th>
                            <th colspan="3" style="min-width:60px;">VA</th>
                            <th colspan="2">เบรกเกอร์</th>
                            <th rowspan="2" style="width:50px;">ท่อ<br>(ø IN)</th>
                            <th colspan="2">สายไฟ</th>
                            <th rowspan="2" style="width:90px;">รายการ</th>
                        </tr>
                        <tr class="sub-header">
                            <th style="width:70px;">SIZE (Sq.mm.)</th>
                            <th style="width:35px;">TYPE</th>
                            <th style="width:30px;">POLE</th>
                            <th style="width:30px;">AT</th>
                            <th style="width:30px;">A</th>
                            <th style="width:30px;">B</th>
                            <th style="width:30px;">C</th>
                            <!-- right sub -->
                            <th style="width:35px;">A</th>
                            <th style="width:35px;">B</th>
                            <th style="width:35px;">C</th>
                            <th style="width:30px;">POLE</th>
                            <th style="width:30px;">AT</th>
                            <th style="width:70px;">SIZE (Sq.mm.)</th>
                            <th style="width:35px;">TYPE</th>
                        </tr>
                    </thead>
                    <tbody id="circuitBody"></tbody>
                    <tfoot>
                        <tr class="footer-row">
                            <td colspan="6" style="text-align:right; padding-right:6px;"></td>
                            <td id="sumA_L">-</td>
                            <td id="sumB_L">-</td>
                            <td id="sumC_L">-</td>
                            <td style="font-size:9px;">A&emsp;&emsp;B&emsp;&emsp;C</td>
                            <td></td>
                            <td id="sumA_R">-</td>
                            <td id="sumB_R">-</td>
                            <td id="sumC_R">-</td>
                            <td colspan="6"></td>
                        </tr>
                        <tr>
                            <td colspan="9" style="text-align:center; font-weight:bold;">รวมโหลดทั้งหมด (VA.)</td>
                            <td id="totalVA_A" style="text-align:center; font-weight:bold;">-</td>
                            <td></td>
                            <td id="totalVA_B" style="text-align:center; font-weight:bold;">-</td>
                            <td colspan="2"></td>
                            <td id="totalVA_C" style="text-align:center; font-weight:bold;">-</td>
                            <td colspan="5"></td>
                        </tr>
                    </tfoot>
                </table>
            </td>
        </tr>

        <!-- ===== Main Breaker Calculation (มาตรฐาน วสท.) ===== -->
        <tr class="calc-row">
            <td colspan="4"><span class="label" style="font-weight:bold;">ระบบจ่ายไฟหลัก</span></td>
            <td colspan="3">
                <select id="mainPhaseSelect" onchange="recalcMainBreaker()">
                    <option value="3">3 Phase (3Ø 4W)</option>
                    <option value="1">1 Phase (1Ø 2W)</option>
                </select>
            </td>
            <td colspan="6"><span class="label" style="font-weight:bold;">กระแสออกแบบ (I<sub>d</sub>) × 1.25</span></td>
            <td colspan="7"><input type="text" id="designCurrent" class="calc-result" value="-" readonly></td>
            <td colspan="4"><span class="label" style="font-weight:bold;">ขนาด Main Breaker (วสท.)</span></td>
            <td colspan="6"><input type="text" id="mainBreakerCalc" class="calc-result" value="-" readonly style="font-size:11px;"></td>
        </tr>

        <!-- ===== Footer Summary ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">กระแสเฟส A</span></td>
            <td colspan="3"><input type="text" id="currentA" value="-" readonly></td>
            <td colspan="6"><span class="label">เมนเบรกเกอร์ (TYPE)</span></td>
            <td colspan="7"><input type="text" id="mainBreakerType" value="MOLDED CASE-THERMAL MAGNETIC TYPE"></td>
            <td colspan="4"><span class="label">ขนาดสายป้อน</span></td>
            <td colspan="6"><input type="text" id="feederWire" value="-" readonly></td>
        </tr>
        <tr class="header-info">
            <td colspan="4"><span class="label">กระแสเฟส B</span></td>
            <td colspan="3"><input type="text" id="currentB" value="-" readonly></td>
            <td colspan="6"><span class="label">ตำแหน่งติดตั้ง (ตอนบน,ตอนล่าง)</span></td>
            <td colspan="7"><input type="text" id="mountPosition" value="ตอนบน"></td>
            <td colspan="4"><span class="label">ขนาดท่อร้อยสายป้อน</span></td>
            <td colspan="6"><input type="text" id="feederConduit" value="-" readonly></td>
        </tr>
        <tr class="header-info">
            <td colspan="4"><span class="label">กระแสเฟส C</span></td>
            <td colspan="3"><input type="text" id="currentC" value="-" readonly></td>
            <td colspan="6"><span class="label">Main Breaker</span></td>
            <td colspan="7"><input type="text" id="mainBreakerSpec" value="-" readonly></td>
            <td colspan="4"><span class="label">ลงวันที่</span></td>
            <td colspan="6"><input type="text" id="dateField" value="-"></td>
        </tr>
    </table>

    <script>
        const sketchup = window.sketchup;
        const MAX_ROWS = 9; // 18 circuits => 9 rows
        let currentSelectedId = null; // Track single selected entity ID

        // Generate SVG single-line diagram
        function generateSLD(numRows) {
            const rowH = 24;
            const totalH = numRows * rowH + 40;
            const cx = 65;
            const busStart = 22;
            const pg = 7;

            let s = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130 ${totalH}" style="width:100%;height:${totalH}px;">`;

            // Main breaker box
            s += `<rect x="${cx - 14}" y="2" width="28" height="14" fill="#333" rx="2"/>`;
            s += `<text x="${cx}" y="11" text-anchor="middle" fill="#fff" font-size="7" font-family="Tahoma">S/N</text>`;

            // Phase labels
            s += `<text x="${cx - pg}" y="${busStart + 7}" text-anchor="middle" font-size="6" font-family="Tahoma">ØA</text>`;
            s += `<text x="${cx}" y="${busStart + 7}" text-anchor="middle" font-size="6" font-family="Tahoma">ØB</text>`;
            s += `<text x="${cx + pg}" y="${busStart + 7}" text-anchor="middle" font-size="6" font-family="Tahoma">ØC</text>`;

            // Bus bars
            const bEnd = totalH - 20;
            s += `<line x1="${cx - pg}" y1="${busStart + 9}" x2="${cx - pg}" y2="${bEnd}" stroke="#000" stroke-width="1.5"/>`;
            s += `<line x1="${cx}" y1="${busStart + 9}" x2="${cx}" y2="${bEnd}" stroke="#000" stroke-width="1.5"/>`;
            s += `<line x1="${cx + pg}" y1="${busStart + 9}" x2="${cx + pg}" y2="${bEnd}" stroke="#000" stroke-width="1.5"/>`;

            // Branches
            for (let i = 0; i < numRows; i++) {
                const y = busStart + 14 + i * rowH;
                const oddN = i * 2 + 1;
                const evenN = i * 2 + 2;

                // Left branch
                s += `<line x1="12" y1="${y}" x2="${cx - pg - 3}" y2="${y}" stroke="#000" stroke-width="0.7"/>`;
                s += `<circle cx="${cx - pg - 7}" cy="${y}" r="2" fill="none" stroke="#000" stroke-width="0.7"/>`;
                s += `<text x="7" y="${y + 3}" text-anchor="end" font-size="7" font-family="Tahoma">${oddN}</text>`;

                // Right branch
                s += `<line x1="${cx + pg + 3}" y1="${y}" x2="118" y2="${y}" stroke="#000" stroke-width="0.7"/>`;
                s += `<circle cx="${cx + pg + 7}" cy="${y}" r="2" fill="none" stroke="#000" stroke-width="0.7"/>`;
                s += `<text x="122" y="${y + 3}" text-anchor="start" font-size="7" font-family="Tahoma">${evenN}</text>`;
            }

            // Ground bus
            s += `<line x1="${cx - 18}" y1="${bEnd + 4}" x2="${cx + 18}" y2="${bEnd + 4}" stroke="#000" stroke-width="1.5"/>`;
            s += `<text x="${cx}" y="${bEnd + 14}" text-anchor="middle" font-size="6" font-family="Tahoma">GROUND BUS</text>`;

            s += `</svg>`;
            return s;
        }

        function emptyCircuit(n) {
            return { circuit_no: n, name: 'SPACE', wire_size: '-', wire_type: '-', conduit: '-', breaker_pole: '-', breaker_at: '-', va_a: '-', va_b: '-', va_c: '-', text_color: '#000' };
        }

        function val(v) { return (v === '' || v === undefined || v === null || v === 0) ? '-' : v; }
        function numval(v) { const n = parseFloat(v); return isNaN(n) ? 0 : n; }

        function populateTable(data) {
            const body = document.getElementById('circuitBody');
            body.innerHTML = '';

            // Prepare left (odd) and right (even) arrays
            let L = [], R = [];
            for (let i = 0; i < MAX_ROWS; i++) {
                L.push(emptyCircuit(i * 2 + 1));
                R.push(emptyCircuit(i * 2 + 2));
            }

            // Map data — Ruby now sends data in the exact format we expect
            if (data && data.length > 0) {
                data.forEach(c => {
                    if (!c) return;
                    const n = c.circuit_no || 0;
                    const idx = Math.floor((n - 1) / 2);
                    if (idx < 0 || idx >= MAX_ROWS) return;
                    const target = (n % 2 === 1) ? L : R;
                    target[idx] = {
                        circuit_no: n,
                        name: c.name || c.circuit_name || 'SPACE',
                        wire_size: val(c.wire_size),
                        wire_type: val(c.wire_type),
                        conduit: val(c.conduit),
                        breaker_pole: val(c.breaker_pole),
                        breaker_at: val(c.breaker_at),
                        va_a: val(c.va_a),
                        va_b: val(c.va_b),
                        va_c: val(c.va_c),
                        va_c: val(c.va_c),
                        text_color: c.text_color, // Pass color through
                        entity_id: c.entity_id // Store ID
                    };
                });
            }

            // Build rows using DOM (not innerHTML) to preserve rowSpan
            const sldHTML = generateSLD(MAX_ROWS);

            for (let i = 0; i < MAX_ROWS; i++) {
                const tr = document.createElement('tr');
                const l = L[i], r = R[i];

                // Use persistent color from Ruby, fallback to black
                const colorL = (l.name !== 'SPACE') ? (l.text_color || '#000') : '#000';
                const colorR = (r.name !== 'SPACE') ? (r.text_color || '#000') : '#000';

                // === LEFT SIDE (9 cells) ===
                addCell(tr, l.name, 'la', colorL, l.entity_id);
                addCell(tr, l.wire_size, '', colorL);
                addCell(tr, l.wire_type, '', colorL);
                addCell(tr, l.conduit, '', colorL);
                addCell(tr, l.breaker_pole, '', colorL);
                addCell(tr, l.breaker_at, '', colorL);
                addCell(tr, l.va_a, '', colorL);
                addCell(tr, l.va_b, '', colorL);
                addCell(tr, l.va_c, '', colorL);

                // === CENTER SLD (only row 0 with rowSpan) ===
                if (i === 0) {
                    const sldTd = document.createElement('td');
                    sldTd.className = 'sld-cell';
                    sldTd.rowSpan = MAX_ROWS;
                    sldTd.innerHTML = sldHTML;
                    tr.appendChild(sldTd);
                }

                // === RIGHT SIDE (10 cells) ===
                addCell(tr, r.circuit_no, '', colorR);
                addCell(tr, r.va_a, '', colorR);
                addCell(tr, r.va_b, '', colorR);
                addCell(tr, r.va_c, '', colorR);
                addCell(tr, r.breaker_pole, '', colorR);
                addCell(tr, r.breaker_at, '', colorR);
                addCell(tr, r.conduit, '', colorR);
                addCell(tr, r.wire_size, '', colorR);
                addCell(tr, r.wire_type, '', colorR);
                addCell(tr, r.name, 'la', colorR, r.entity_id); // FIXED: Added r.entity_id

                body.appendChild(tr);
            }

            calculateTotals(L, R);
            autoFit();
        }

        function addCell(tr, text, cls, color, id) {
            const td = document.createElement('td');
            td.textContent = text;
            if (cls) td.className = cls;
            if (color) td.style.color = color;

            if (id) {
                td.classList.add('clickable');
                td.setAttribute('data-entity-id', id);
                // Restore selected state if previously selected
                if (currentSelectedId === String(id)) {
                    td.classList.add('selected');
                }
                td.title = "Click to Select/Unselect in Model";
                td.onclick = function () { toggleCircuit(id, td); };
            }

            tr.appendChild(td);
        }

        function toggleCircuit(id, tdElement) {
            const idStr = String(id);
            const wasSame = (currentSelectedId === idStr);

            // Clear previous selection highlight
            if (currentSelectedId) {
                document.querySelectorAll('[data-entity-id="' + currentSelectedId + '"]').forEach(function(el) {
                    el.classList.remove('selected');
                });
            }

            if (wasSame) {
                // Click same circuit again => deselect
                currentSelectedId = null;
                if (window.sketchup) {
                    sketchup.toggleCircuit(idStr, false);
                } else {
                    console.log("Deselect circuit: " + id);
                }
            } else {
                // Select new circuit (deselect previous first)
                currentSelectedId = idStr;
                document.querySelectorAll('[data-entity-id="' + id + '"]').forEach(function(el) {
                    el.classList.add('selected');
                });
                if (window.sketchup) {
                    sketchup.toggleCircuit(idStr, true);
                } else {
                    console.log("Select circuit: " + id);
                }
            }
        }

        function getRandomColor() {
            // Generate a random dark color (HSL with limits)
            // Hue: 0-360, Saturation: 70-100%, Lightness: 20-40% (Dark enough for white bg)
            const h = Math.floor(Math.random() * 360);
            const s = Math.floor(Math.random() * 30) + 70; // 70-100%
            const l = Math.floor(Math.random() * 25) + 20; // 20-45%
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        function calculateTotals(L, R) {
            let tA = 0, tB = 0, tC = 0;
            [...L, ...R].forEach(c => {
                tA += numval(c.va_a);
                tB += numval(c.va_b);
                tC += numval(c.va_c);
            });

            const fmt = v => v > 0 ? v.toLocaleString() : '-';
            document.getElementById('sumA_L').textContent = fmt(tA);
            document.getElementById('sumB_L').textContent = fmt(tB);
            document.getElementById('sumC_L').textContent = fmt(tC);
            document.getElementById('sumA_R').textContent = fmt(tA);
            document.getElementById('sumB_R').textContent = fmt(tB);
            document.getElementById('sumC_R').textContent = fmt(tC);
            document.getElementById('totalVA_A').textContent = fmt(tA);
            document.getElementById('totalVA_B').textContent = fmt(tB);
            document.getElementById('totalVA_C').textContent = fmt(tC);

            const v1p = 220;
            document.getElementById('currentA').value = tA > 0 ? (tA / v1p).toFixed(2) + ' A.' : '-';
            document.getElementById('currentB').value = tB > 0 ? (tB / v1p).toFixed(2) + ' A.' : '-';
            document.getElementById('currentC').value = tC > 0 ? (tC / v1p).toFixed(2) + ' A.' : '-';

            recalcMainBreaker();
        }

        // ===== มาตรฐาน วสท. (EIT) - Main Breaker Calculation =====
        const EIT_BREAKER_AT = [10, 15, 16, 20, 25, 30, 32, 40, 50, 63, 75, 80, 100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 500, 630, 800, 1000, 1250, 1600];
        const EIT_BREAKER_AF = [50, 100, 160, 225, 250, 400, 630, 800, 1000, 1250, 1600];
        const EIT_FEEDER_WIRE = [
            { size: 2.5, amp: 25 }, { size: 4, amp: 33 }, { size: 6, amp: 44 },
            { size: 10, amp: 61 }, { size: 16, amp: 82 }, { size: 25, amp: 108 },
            { size: 35, amp: 134 }, { size: 50, amp: 167 }, { size: 70, amp: 207 },
            { size: 95, amp: 252 }, { size: 120, amp: 290 }, { size: 150, amp: 334 },
            { size: 185, amp: 380 }, { size: 240, amp: 442 }, { size: 300, amp: 510 },
            { size: 400, amp: 607 }, { size: 500, amp: 703 }
        ];
        const EIT_CONDUIT = [
            { maxSize: 4, conduit: '1/2"' }, { maxSize: 10, conduit: '3/4"' },
            { maxSize: 16, conduit: '1"' }, { maxSize: 25, conduit: '1-1/4"' },
            { maxSize: 35, conduit: '1-1/2"' }, { maxSize: 70, conduit: '2"' },
            { maxSize: 120, conduit: '2-1/2"' }, { maxSize: 185, conduit: '3"' },
            { maxSize: 300, conduit: '4"' }, { maxSize: 500, conduit: '5"' }
        ];
        const EIT_GROUND_WIRE = [
            { maxAT: 20, size: 2.5 }, { maxAT: 40, size: 4 },
            { maxAT: 70, size: 6 }, { maxAT: 100, size: 10 },
            { maxAT: 200, size: 16 }, { maxAT: 400, size: 25 },
            { maxAT: 600, size: 35 }, { maxAT: 1600, size: 50 }
        ];

        function selectMainBreakerAT(minAmp) {
            for (const at of EIT_BREAKER_AT) { if (at >= minAmp) return at; }
            return EIT_BREAKER_AT[EIT_BREAKER_AT.length - 1];
        }
        function selectMainBreakerAF(at) {
            for (const af of EIT_BREAKER_AF) { if (af >= at) return af; }
            return EIT_BREAKER_AF[EIT_BREAKER_AF.length - 1];
        }
        function selectMainFeederWire(breakerAT) {
            for (const w of EIT_FEEDER_WIRE) { if (w.amp >= breakerAT) return w; }
            return EIT_FEEDER_WIRE[EIT_FEEDER_WIRE.length - 1];
        }
        function selectMainGroundWire(breakerAT) {
            for (const g of EIT_GROUND_WIRE) { if (breakerAT <= g.maxAT) return g.size; }
            return 50;
        }
        function selectMainConduit(wireSizeSqmm) {
            for (const c of EIT_CONDUIT) { if (wireSizeSqmm <= c.maxSize) return c.conduit + ' PVC'; }
            return '5" PVC';
        }

        function recalcMainBreaker() {
            const phase = parseInt(document.getElementById('mainPhaseSelect').value);
            const tA = numval(document.getElementById('sumA_L').textContent.replace(/,/g, ''));
            const tB = numval(document.getElementById('sumB_L').textContent.replace(/,/g, ''));
            const tC = numval(document.getElementById('sumC_L').textContent.replace(/,/g, ''));

            let totalVA, designCurrent, pole, icVoltage;

            if (phase === 1) {
                totalVA = Math.max(tA, tB, tC);
                designCurrent = totalVA / 220;
                pole = 2;
                icVoltage = '240 V.ac';
            } else {
                totalVA = tA + tB + tC;
                designCurrent = totalVA / (Math.sqrt(3) * 380);
                pole = 3;
                icVoltage = '415 V.ac';
            }

            if (designCurrent <= 0) {
                document.getElementById('designCurrent').value = '-';
                document.getElementById('mainBreakerCalc').value = '-';
                document.getElementById('mainBreakerSpec').value = '-';
                document.getElementById('feederWire').value = '-';
                document.getElementById('feederConduit').value = '-';
                return;
            }

            const minAT = designCurrent * 1.25;
            const breakerAT = selectMainBreakerAT(minAT);
            const breakerAF = selectMainBreakerAF(breakerAT);
            const feeder = selectMainFeederWire(breakerAT);
            const groundSize = selectMainGroundWire(breakerAT);
            const conduit = selectMainConduit(feeder.size);

            document.getElementById('designCurrent').value =
                designCurrent.toFixed(2) + ' A. (\u00d71.25 = ' + minAT.toFixed(2) + ' A.)';
            document.getElementById('mainBreakerCalc').value =
                pole + 'P ' + breakerAT + ' AT. ' + breakerAF + ' AF.';
            document.getElementById('mainBreakerSpec').value =
                pole + 'P ' + breakerAT + ' AT. ' + breakerAF + ' AF. IC > 25 KA ' + icVoltage;

            let wireStr;
            if (phase === 1) {
                wireStr = 'L+N : 2-1/Cx' + feeder.size + ', G : 1-1/Cx' + groundSize + ' sq.mm. (THW)';
            } else {
                wireStr = '3-1/Cx' + feeder.size + ', N : 1-1/Cx' + feeder.size + ', G : 1-1/Cx' + groundSize + ' sq.mm. (THW)';
            }
            document.getElementById('feederWire').value = wireStr;
            document.getElementById('feederConduit').value = conduit;

            if (phase === 1) {
                document.getElementById('systemType').value = '1 \u00D8 2 WIRE WITH GROUND 220 V.ac. 50 Hz';
            } else {
                document.getElementById('systemType').value = '3 \u00D8 4 WIRE WITH GROUND 380/220 V.ac. 50 Hz';
            }
        }

        function requestData() {
            if (sketchup) {
                sketchup.requestData();
            } else {
                // Sample data matching the reference image
                populateTable([
                    { circuit_no: 1, name: 'LIGHTNING+SIGNAGE', wire_size: 'L+N : 2-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: 1355, va_b: '', va_c: '' },
                    { circuit_no: 3, name: 'RECEPTACLE', wire_size: 'L+N : 2-1/Cx2.5\nG : 1-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: '', va_b: 1360, va_c: '' },
                    { circuit_no: 5, name: 'RECEPTACLE', wire_size: 'L+N : 2-1/Cx2.5\nG : 1-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: '', va_b: '', va_c: 1530 },
                    { circuit_no: 2, name: 'POWER PLUG', wire_size: 'L+N : 2-1/Cx2.5\nG : 1-1/Cx2.5', wire_type: 'THW', conduit: '3/4" PVC', breaker_pole: 3, breaker_at: 20, va_a: 2600, va_b: '', va_c: '' },
                    { circuit_no: 4, name: 'CDU1 (24,000 BTU)', wire_size: 'L+N : 2-1/Cx6\nG : 1-1/Cx4', wire_type: 'THW', conduit: '3/4" PVC', breaker_pole: 1, breaker_at: 30, va_a: 3000, va_b: '', va_c: '' },
                    { circuit_no: 6, name: 'CDU2 (24,000 BTU)', wire_size: 'L+N : 2-1/Cx6\nG : 1-1/Cx4', wire_type: 'THW', conduit: '3/4" PVC', breaker_pole: 1, breaker_at: 30, va_a: '', va_b: 3000, va_c: '' },
                    { circuit_no: 8, name: 'CDU3 (24,000 BTU)', wire_size: 'L+N : 2-1/Cx6\nG : 1-1/Cx4', wire_type: 'THW', conduit: '3/4" PVC', breaker_pole: 1, breaker_at: 30, va_a: '', va_b: '', va_c: 3000 },
                ]);
            }
        }

        function exportToCSV() {
            if (sketchup) sketchup.exportCSV();
            else alert('Export CSV (ทดสอบ - ไม่ได้เชื่อมต่อ SketchUp)');
        }

        function autoFit() {
            setTimeout(function () {
                const table = document.getElementById('mainTable');
                // Calculate height based on table and toolbar, plus a small buffer
                const h = table.offsetHeight + 40 + 50; // 40 for toolbar + 20 buffer

                if (window.sketchup) {
                    sketchup.resizeDialog(window.innerWidth, h);
                }
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', function () {
            requestData();
            autoFit();
        });

        // Periodically save dialog position so Ruby always has the latest
        // Compute chromeHeight once to avoid fluctuation-induced Y drift
        var _chromeHeight = 0;
        setTimeout(function() {
            _chromeHeight = window.outerHeight - window.innerHeight;
        }, 300);
        setInterval(function() {
            var x = window.screenX;
            var y = window.screenY - _chromeHeight;
            if (x > 0 || y > 0) {
                sketchup.savePosition(x, y);
            }
        }, 500);
    </script>

</body>

</html>