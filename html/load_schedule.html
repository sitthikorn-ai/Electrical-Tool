<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tahoma', 'Leelawadee UI', 'Microsoft Sans Serif', sans-serif;
            font-size: 9px;
            background: #fff;
            color: #000;
            padding: 4px;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #000;
        }

        .main-table td,
        .main-table th {
            border: 1px solid #000;
            padding: 1px 3px;
            vertical-align: middle;
            font-size: 9px;
        }

        .title-row td {
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            padding: 2px;
        }

        .header-info td {
            font-size: 9px;
            padding: 1px 4px;
            position: relative;
        }

        .header-info .label {
            font-weight: normal;
            white-space: nowrap;
        }

        .header-info input {
            border: none;
            border-bottom: 1px dotted #999;
            background: transparent;
            font-family: inherit;
            font-size: 9px;
            outline: none;
            width: 100%;
            padding: 0px 2px;
        }

        .header-info input:focus {
            border-bottom: 1px solid #0066d6;
            background: #f0f7ff;
        }

        .circuit-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .circuit-table th,
        .circuit-table td {
            border: 1px solid #000;
            padding: 0px 2px;
            text-align: center;
            font-size: 8px;
            vertical-align: middle;
            height: 18px;
            line-height: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .circuit-table tbody tr {
            height: 18px;
        }

        .circuit-table th {
            background-color: #fff;
            font-weight: bold;
            font-size: 8px;
        }

        .circuit-table .sub-header th {
            font-weight: normal;
            font-size: 7.5px;
        }

        .circuit-table td.la {
            text-align: left;
            padding-left: 3px;
        }

        .sld-cell {
            position: static !important;
            padding: 0 !important;
            vertical-align: top !important;
        }

        .footer-row td {
            font-weight: bold;
        }

        .toolbar {
            margin-bottom: 3px;
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .toolbar button {
            padding: 1px 6px;
            font-size: 9px;
            border: 1px solid #999;
            background: #f0f0f0;
            cursor: pointer;
            font-family: inherit;
            border-radius: 2px;
            line-height: 1.4;
            white-space: nowrap;
        }

        .toolbar button:hover {
            background: #e0e0e0;
        }

        @media print {
            .toolbar {
                display: none;
            }

            body {
                padding: 0;
            }
        }

        .clickable {
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }

        .clickable:hover {
            color: #0066d6 !important;
        }

        .clickable.selected {
            background: #d0e8ff;
            outline: 2px solid #0066d6;
            outline-offset: -2px;
            border-radius: 2px;
        }

        .calc-row td {
            background: #f0f4ff;
            padding: 1px 4px;
            font-size: 9px;
        }

        .calc-row select {
            border: 1px solid #888;
            background: #fff;
            font-family: inherit;
            font-size: 9px;
            padding: 1px 3px;
            width: 100%;
            border-radius: 2px;
            cursor: pointer;
        }

        .calc-row select:focus {
            border-color: #0066d6;
            outline: none;
        }

        .calc-row .calc-result {
            font-weight: bold;
            color: #c00;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 9px;
            width: 100%;
            padding: 0px 2px;
        }

        .toolbar button.active {
            background: #0066d6;
            color: #fff;
            border-color: #004a9e;
        }

        .swap-pick {
            cursor: pointer;
        }

        .swap-pick:hover {
            background: #ffe0b2 !important;
        }

        .swap-selected {
            background: #ff9800 !important;
            outline: 2px solid #e65100;
            outline-offset: -2px;
        }

        .span-group-cell {
            position: static !important;
            vertical-align: middle !important;
            padding: 0 3px !important;
            font-size: 7.5px;
            text-align: center;
        }

        .span-group-cell.la {
            text-align: left;
            padding-left: 3px !important;
        }

        .col-resizer {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
        }

        .col-resizer:hover,
        .col-resizer.active {
            background: rgba(0,102,214,0.3);
        }

        .circuit-table th {
            position: relative;
        }

        .row-resizer {
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 6px;
            cursor: row-resize;
            z-index: 10;
        }

        .row-resizer:hover,
        .row-resizer.active {
            background: rgba(0,102,214,0.3);
        }

        .circuit-table tbody td {
            position: relative;
        }
    </style>
</head>

<body>

    <div class="toolbar">
        <button onclick="requestData()">Import SU Circuit</button>
        <button onclick="exportToCSV()">Export CSV</button>
        <button onclick="window.print()">Print PDF</button>
        <span style="border-left:1px solid #999; margin:0 4px;"></span>
        <button onclick="doAutoBalance()" title="‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">‚ö° Auto Balance</button>
        <button id="btnSwap" onclick="toggleSwapMode()" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏ß‡∏á‡∏à‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">üîÑ Manual Swap</button>
        <button onclick="doUpdateNames()" title="‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠ LP-N ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Circuit No. ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠ Group ‡πÉ‡∏ô Model">üìù Update LP-N to SU</button>
        <button id="btnSave" onclick="doSaveArrangement()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏•‡∏á‡πÉ‡∏ô Model">üíæ Save Edited Load Data</button>
        <span id="swapStatus" style="font-size:10px; color:#666; align-self:center;"></span>
    </div>

    <table class="main-table" id="mainTable">
        <!-- ===== Title ===== -->
        <tr class="title-row">
            <td colspan="31">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</td>
        </tr>

        <!-- ===== Header Row 1 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏á‡∏¢‡πà‡∏≠‡∏¢</span></td>
            <td colspan="10"><input type="text" id="panelName" value="LC1"></td>
            <td colspan="1"><span class="label">‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ß‡∏á‡∏à‡∏£‡∏¢‡πà‡∏≠‡∏¢</span></td>
            <td colspan="8"><input type="text" id="subBreakerRating" value="IC. > 6 KA. at 240 V.ac., 415 V.ac."></td>
            <td colspan="1"><span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</span></td>
            <td colspan="1"><input type="text" id="installLocation" value=""></td>
            <td colspan="3"><input type="text" id="drawingRef" value=""></td>
        </tr>
        <!-- ===== Header Row 2 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span></td>
            <td colspan="10"><input type="text" id="systemType" value="3 √ò 4 WIRE WITH GROUND 380/220 V.ac. 50 Hz"></td>
            <td colspan="1"><span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏á‡∏à‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span></td>
            <td colspan="4"><input type="text" id="maxCircuits" value="30 ‡∏ß‡∏á‡∏à‡∏£"></td>
            <td colspan="3"><span class="label">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ö‡∏≤‡∏£‡πå</span></td>
            <td colspan="4"><input type="text" id="busbarRating" value="> 100 A."></td>
            <td colspan="1"><span class="label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö</span></td>
            <td colspan="5"><input type="text" id="drawingNo" value="-"></td>
        </tr>
        <!-- ===== Header Row 3 ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</span></td>
            <td colspan="10"><input type="text" id="protectionLevel" value="NEMA TYPE 1"></td>
            <td colspan="17"></td>
        </tr>

        <!-- ===== Circuit Table ===== -->
        <tr>
            <td colspan="31" style="padding:0; border:none;">
                <table class="circuit-table" id="circuitTable">
                    <colgroup>
                        <col style="width:100px"><!-- 0: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ L -->
                        <col data-resizable="1"><!-- 1: SIZE L (auto-fit) -->
                        <col style="width:26px"><!-- 2: TYPE L -->
                        <col style="width:36px"><!-- 3: ‡∏ó‡πà‡∏≠ L -->
                        <col style="width:24px"><!-- 4: POLE L -->
                        <col style="width:24px"><!-- 5: AT L -->
                        <col style="width:34px"><!-- 6: R -->
                        <col style="width:34px"><!-- 7: S -->
                        <col style="width:34px"><!-- 8: T -->
                        <col style="width:24px"><!-- 9: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà L -->
                        <col style="width:80px"><!-- 10: SLD -->
                        <col style="width:24px"><!-- 11: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà R -->
                        <col style="width:34px"><!-- 12: R -->
                        <col style="width:34px"><!-- 13: S -->
                        <col style="width:34px"><!-- 14: T -->
                        <col style="width:24px"><!-- 15: POLE R -->
                        <col style="width:24px"><!-- 16: AT R -->
                        <col style="width:36px"><!-- 17: ‡∏ó‡πà‡∏≠ R -->
                        <col data-resizable="1"><!-- 18: SIZE R (auto-fit) -->
                        <col style="width:26px"><!-- 19: TYPE R -->
                        <col style="width:100px"><!-- 20: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ R -->
                    </colgroup>
                    <thead>
                        <tr>
                            <!-- LEFT 10 cols -->
                            <th rowspan="2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th colspan="2">‡∏™‡∏≤‡∏¢‡πÑ‡∏ü</th>
                            <th rowspan="2">‡∏ó‡πà‡∏≠<br>(√∏ IN)</th>
                            <th colspan="2">‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</th>
                            <th colspan="3">VA</th>
                            <th rowspan="2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <!-- CENTER 1 col -->
                            <th rowspan="2">‡πÑ‡∏î‡∏≠‡∏∞‡πÅ‡∏Å‡∏£‡∏°</th>
                            <!-- RIGHT 10 cols -->
                            <th rowspan="2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th colspan="3">VA</th>
                            <th colspan="2">‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</th>
                            <th rowspan="2">‡∏ó‡πà‡∏≠<br>(√∏ IN)</th>
                            <th colspan="2">‡∏™‡∏≤‡∏¢‡πÑ‡∏ü</th>
                            <th rowspan="2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                        </tr>
                        <tr class="sub-header">
                            <th>SIZE (Sq.mm.)</th>
                            <th>TYPE</th>
                            <th>POLE</th>
                            <th>AT</th>
                            <th>R</th>
                            <th>S</th>
                            <th>T</th>
                            <!-- right sub -->
                            <th>R</th>
                            <th>S</th>
                            <th>T</th>
                            <th>POLE</th>
                            <th>AT</th>
                            <th>SIZE (Sq.mm.)</th>
                            <th>TYPE</th>
                        </tr>
                    </thead>
                    <tbody id="circuitBody"></tbody>
                    <tfoot>
                        <tr class="footer-row">
                            <td colspan="6" style="text-align:right; padding-right:6px;"></td>
                            <td id="sumA_L">-</td>
                            <td id="sumB_L">-</td>
                            <td id="sumC_L">-</td>
                            <td></td>
                            <td style="font-size:9px; font-weight:bold;">R&emsp;&emsp;S&emsp;&emsp;T</td>
                            <td></td>
                            <td id="sumA_R">-</td>
                            <td id="sumB_R">-</td>
                            <td id="sumC_R">-</td>
                            <td colspan="6"></td>
                        </tr>
                        <tr>
                            <td colspan="10" style="text-align:center; font-weight:bold;">‡∏£‡∏ß‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (VA.)</td>
                            <td></td>
                            <td></td>
                            <td id="totalVA_A" style="text-align:center; font-weight:bold;">-</td>
                            <td id="totalVA_B" style="text-align:center; font-weight:bold;">-</td>
                            <td id="totalVA_C" style="text-align:center; font-weight:bold;">-</td>
                            <td colspan="6"></td>
                        </tr>
                    </tfoot>
                </table>
            </td>
        </tr>

        <!-- ===== Main Breaker Calculation (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏ß‡∏™‡∏ó.) ===== -->
        <tr class="calc-row">
            <td colspan="4"><span class="label" style="font-weight:bold;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ü‡∏´‡∏•‡∏±‡∏Å</span></td>
            <td colspan="3">
                <select id="mainPhaseSelect" onchange="recalcMainBreaker()">
                    <option value="3">3 Phase (3√ò 4W)</option>
                    <option value="1">1 Phase (1√ò 2W)</option>
                </select>
            </td>
            <td colspan="6"><span class="label" style="font-weight:bold;">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö (I<sub>d</sub>) √ó 1.25</span></td>
            <td colspan="8"><input type="text" id="designCurrent" class="calc-result" value="-" readonly></td>
            <td colspan="4"><span class="label" style="font-weight:bold;">‡∏Ç‡∏ô‡∏≤‡∏î Main Breaker (‡∏ß‡∏™‡∏ó.)</span></td>
            <td colspan="6"><input type="text" id="mainBreakerCalc" class="calc-result" value="-" readonly style="font-size:11px;"></td>
        </tr>

        <!-- ===== Footer Summary ===== -->
        <tr class="header-info">
            <td colspan="4"><span class="label">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏ü‡∏™ R (Brown)</span></td>
            <td colspan="3"><input type="text" id="currentA" value="-" readonly></td>
            <td colspan="6"><span class="label">‡πÄ‡∏°‡∏ô‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (TYPE)</span></td>
            <td colspan="8"><input type="text" id="mainBreakerType" value="MOLDED CASE-THERMAL MAGNETIC TYPE"></td>
            <td colspan="4"><span class="label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏ô</span></td>
            <td colspan="6"><input type="text" id="feederWire" value="-" readonly></td>
        </tr>
        <tr class="header-info">
            <td colspan="4"><span class="label">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏ü‡∏™ S (Black)</span></td>
            <td colspan="3"><input type="text" id="currentB" value="-" readonly></td>
            <td colspan="6"><span class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô,‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á)</span></td>
            <td colspan="8"><input type="text" id="mountPosition" value="‡∏ï‡∏≠‡∏ô‡∏ö‡∏ô"></td>
            <td colspan="4"><span class="label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡πà‡∏≠‡∏£‡πâ‡∏≠‡∏¢‡∏™‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏ô</span></td>
            <td colspan="6"><input type="text" id="feederConduit" value="-" readonly></td>
        </tr>
        <tr class="header-info">
            <td colspan="4"><span class="label">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏ü‡∏™ T (Grey)</span></td>
            <td colspan="3"><input type="text" id="currentC" value="-" readonly></td>
            <td colspan="6"><span class="label">Main Breaker</span></td>
            <td colspan="8"><input type="text" id="mainBreakerSpec" value="-" readonly></td>
            <td colspan="4"><span class="label">‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span></td>
            <td colspan="6"><input type="text" id="dateField" value="-"></td>
        </tr>
    </table>

    <script>
        const sketchup = window.sketchup;
        const MAX_ROWS = 15; // 30 circuits => 15 rows
        let currentSelectedId = null; // Track single selected entity ID

        // ===== Swap Mode State =====
        let swapMode = false;
        let swapSelections = []; // array of up to 2 selected circuit_no values

        // Generate SVG single-line diagram
        // Each circuit connects to the busbar matching its phase:
        //   ((slot-1)/2)%3 => 0=R, 1=S, 2=T
        function generateSLD(numRows) {
            const rowH = 18;
            const totalH = numRows * rowH;
            const cx = 65;
            const pg = 8; // spacing between busbars

            // Busbar X positions: R(left), S(center), T(right)
            const busR = cx - pg;
            const busS = cx;
            const busT = cx + pg;
            const busX = [busR, busS, busT]; // indexed by phase 0,1,2

            let s = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130 ${totalH}" style="width:100%;height:${totalH}px;display:block;">`;

            // Phase labels at top (R, S, T) ‚Äî inside first row area
            const labelY = 6;
            s += `<text x="${busR}" y="${labelY}" text-anchor="middle" font-size="7" font-weight="bold" font-family="Tahoma">R</text>`;
            s += `<text x="${busS}" y="${labelY}" text-anchor="middle" font-size="7" font-weight="bold" font-family="Tahoma">S</text>`;
            s += `<text x="${busT}" y="${labelY}" text-anchor="middle" font-size="7" font-weight="bold" font-family="Tahoma">T</text>`;

            // Bus bars (3 vertical lines)
            const bTop = 8;
            const bEnd = totalH - 4;
            s += `<line x1="${busR}" y1="${bTop}" x2="${busR}" y2="${bEnd}" stroke="#000" stroke-width="1.2"/>`;
            s += `<line x1="${busS}" y1="${bTop}" x2="${busS}" y2="${bEnd}" stroke="#000" stroke-width="1.2"/>`;
            s += `<line x1="${busT}" y1="${bTop}" x2="${busT}" y2="${bEnd}" stroke="#000" stroke-width="1.2"/>`;

            // Branches ‚Äî each circuit connects to the correct busbar
            for (let i = 0; i < numRows; i++) {
                const y = Math.round(rowH / 2 + i * rowH);
                const oddN = i * 2 + 1;   // left circuit number
                const evenN = i * 2 + 2;  // right circuit number

                // Phase index: ((slot-1)/2) % 3
                const phaseL = Math.floor((oddN - 1) / 2) % 3;
                const phaseR = Math.floor((evenN - 1) / 2) % 3;
                const bxL = busX[phaseL];
                const bxR = busX[phaseR];

                // Left branch: line from left edge to busbar, hollow circle on busbar
                s += `<line x1="10" y1="${y}" x2="${bxL}" y2="${y}" stroke="#000" stroke-width="0.7"/>`;
                s += `<circle cx="${bxL}" cy="${y}" r="2.8" fill="none" stroke="#000" stroke-width="0.8"/>`;
                s += `<text x="6" y="${y + 3}" text-anchor="end" font-size="7" font-family="Tahoma">${oddN}</text>`;

                // Right branch: line from busbar to right edge, hollow circle on busbar
                s += `<line x1="${bxR}" y1="${y}" x2="120" y2="${y}" stroke="#000" stroke-width="0.7"/>`;
                s += `<circle cx="${bxR}" cy="${y}" r="2.8" fill="none" stroke="#000" stroke-width="0.8"/>`;
                s += `<text x="124" y="${y + 3}" text-anchor="start" font-size="7" font-family="Tahoma">${evenN}</text>`;
            }

            s += `</svg>`;
            return s;
        }

        function emptyCircuit(n) {
            const p = Math.floor((n - 1) / 2) % 3;
            return { circuit_no: n, name: 'SPACE', wire_size: '-', wire_type: '-', conduit: '-', breaker_pole: '-', breaker_at: '-', va_a: p === 0 ? '-' : '', va_b: p === 1 ? '-' : '', va_c: p === 2 ? '-' : '', text_color: '#000', span_group: null, span_position: 0, span_size: 1 };
        }

        function val(v) { return (v === '' || v === undefined || v === null || v === 0) ? '-' : v; }
        function numval(v) { const n = parseFloat(v); return isNaN(n) ? 0 : n; }

        function populateTable(data) {
            const body = document.getElementById('circuitBody');
            body.innerHTML = '';

            // Prepare left (odd) and right (even) arrays
            let L = [], R = [];
            for (let i = 0; i < MAX_ROWS; i++) {
                L.push(emptyCircuit(i * 2 + 1));
                R.push(emptyCircuit(i * 2 + 2));
            }

            // Map data into slot arrays
            if (data && data.length > 0) {
                data.forEach(c => {
                    if (!c) return;
                    const n = c.circuit_no || 0;
                    const idx = Math.floor((n - 1) / 2);
                    if (idx < 0 || idx >= MAX_ROWS) return;
                    const target = (n % 2 === 1) ? L : R;
                    // Determine active phase: ((slot-1)/2) % 3 => 0=R, 1=S, 2=T
                    const phaseIdx = Math.floor((n - 1) / 2) % 3;
                    const is3Phase = c.span_group || (c.span_size && c.span_size > 1);
                    function vaCell(raw, isActive) {
                        if (is3Phase) {
                            const num = parseFloat(raw);
                            return (!isNaN(num) && num !== 0) ? raw : '';
                        }
                        if (!isActive) return '';
                        const num = parseFloat(raw);
                        return (!isNaN(num) && num !== 0) ? raw : '-';
                    }

                    target[idx] = {
                        circuit_no: n,
                        name: c.name || c.circuit_name || 'SPACE',
                        wire_size: val(c.wire_size),
                        wire_type: val(c.wire_type),
                        conduit: val(c.conduit),
                        breaker_pole: val(c.breaker_pole),
                        breaker_at: val(c.breaker_at),
                        va_a: vaCell(c.va_a, phaseIdx === 0),
                        va_b: vaCell(c.va_b, phaseIdx === 1),
                        va_c: vaCell(c.va_c, phaseIdx === 2),
                        text_color: c.text_color,
                        entity_id: c.entity_id,
                        span_group: c.span_group || null,
                        span_position: c.span_position || 0,
                        span_size: c.span_size || 1
                    };
                });
            }

            // Track which span_groups already had their first row rendered
            const renderedSpanGroups = {};

            // Build rows using DOM
            const sldHTML = generateSLD(MAX_ROWS);

            for (let i = 0; i < MAX_ROWS; i++) {
                const tr = document.createElement('tr');
                const l = L[i], r = R[i];

                const colorL = (l.name !== 'SPACE') ? (l.text_color || '#000') : '#000';
                const colorR = (r.name !== 'SPACE') ? (r.text_color || '#000') : '#000';

                // === LEFT SIDE ===
                buildSideCells(tr, l, colorL, renderedSpanGroups, 'left');

                // === CENTER SLD (only row 0 with rowSpan) ===
                if (i === 0) {
                    const sldTd = document.createElement('td');
                    sldTd.className = 'sld-cell';
                    sldTd.rowSpan = MAX_ROWS;
                    sldTd.innerHTML = sldHTML;
                    tr.appendChild(sldTd);
                }

                // === RIGHT SIDE ===
                buildSideCells(tr, r, colorR, renderedSpanGroups, 'right');

                body.appendChild(tr);
            }

            calculateTotals(L, R);
            autoFit();
        }

        // Build cells for one side of a row, handling 3-phase rowSpan
        function buildSideCells(tr, c, color, renderedSpanGroups, side) {
            const isSpan = c.span_group && c.span_size > 1;
            const isFirstOfSpan = isSpan && c.span_position === 0;
            const isContOfSpan = isSpan && c.span_position > 0;
            const spanKey = c.span_group + '_' + side;

            if (isFirstOfSpan) {
                renderedSpanGroups[spanKey] = true;
            }

            // Shared cells: name, wire_size, wire_type, conduit, breaker_pole, breaker_at
            // These get rowSpan on first row of a 3-phase group; skipped on continuation rows
            const sn = c.circuit_no; // slot number for data-slot tagging
            const cellsBefore = tr.cells.length;
            if (side === 'left') {
                if (isContOfSpan) {
                    addCell(tr, c.va_a, '', color, null, undefined, sn);
                    addCell(tr, c.va_b, '', color, null, undefined, sn);
                    addCell(tr, c.va_c, '', color, null, undefined, sn);
                    addCell(tr, c.circuit_no, '', color, c.entity_id, undefined, sn);
                } else {
                    const rs = isFirstOfSpan ? c.span_size : undefined;
                    addCell(tr, c.name, 'la', color, c.entity_id, rs, sn);
                    addCell(tr, c.wire_size, '', color, null, rs, sn);
                    addCell(tr, c.wire_type, '', color, null, rs, sn);
                    addCell(tr, c.conduit, '', color, null, rs, sn);
                    addCell(tr, c.breaker_pole, '', color, null, rs, sn);
                    addCell(tr, c.breaker_at, '', color, null, rs, sn);
                    addCell(tr, c.va_a, '', color, null, undefined, sn);
                    addCell(tr, c.va_b, '', color, null, undefined, sn);
                    addCell(tr, c.va_c, '', color, null, undefined, sn);
                    addCell(tr, c.circuit_no, '', color, c.entity_id, undefined, sn);
                }
            } else {
                // Right side (mirrored column order)
                if (isContOfSpan) {
                    addCell(tr, c.circuit_no, '', color, c.entity_id, undefined, sn);
                    addCell(tr, c.va_a, '', color, null, undefined, sn);
                    addCell(tr, c.va_b, '', color, null, undefined, sn);
                    addCell(tr, c.va_c, '', color, null, undefined, sn);
                } else {
                    const rs = isFirstOfSpan ? c.span_size : undefined;
                    addCell(tr, c.circuit_no, '', color, c.entity_id, undefined, sn);
                    addCell(tr, c.va_a, '', color, null, undefined, sn);
                    addCell(tr, c.va_b, '', color, null, undefined, sn);
                    addCell(tr, c.va_c, '', color, null, undefined, sn);
                    addCell(tr, c.breaker_pole, '', color, null, rs, sn);
                    addCell(tr, c.breaker_at, '', color, null, rs, sn);
                    addCell(tr, c.conduit, '', color, null, rs, sn);
                    addCell(tr, c.wire_size, '', color, null, rs, sn);
                    addCell(tr, c.wire_type, '', color, null, rs, sn);
                    addCell(tr, c.name, 'la', color, c.entity_id, rs, sn);
                }
            }

            // Tag newly added cells with span-group for swap highlighting
            if (c.span_group) {
                var sgKey = c.span_group + '_' + side;
                for (var ci = cellsBefore; ci < tr.cells.length; ci++) {
                    tr.cells[ci].setAttribute('data-span-group', sgKey);
                }
            }
        }

        function addCell(tr, text, cls, color, id, rowSpanVal, slotNo) {
            const td = document.createElement('td');
            if (cls) td.className = cls;
            if (color) td.style.color = color;
            const displayText = (text != null) ? String(text).replace(/\n/g, ', ') : '';
            if (rowSpanVal && rowSpanVal > 1) {
                td.rowSpan = rowSpanVal;
                td.classList.add('span-group-cell');
            }
            td.textContent = displayText;

            if (slotNo !== undefined) {
                td.setAttribute('data-slot', slotNo);
            }

            if (id) {
                td.classList.add('clickable');
                td.setAttribute('data-entity-id', id);
                if (currentSelectedId === String(id)) {
                    td.classList.add('selected');
                }
                td.title = "Click to Select/Unselect in Model";
                td.onclick = function () {
                    if (swapMode) return;
                    toggleCircuit(id, td);
                };
            }

            tr.appendChild(td);
        }

        function toggleCircuit(id, tdElement) {
            const idStr = String(id);
            const wasSame = (currentSelectedId === idStr);

            if (currentSelectedId) {
                document.querySelectorAll('[data-entity-id="' + currentSelectedId + '"]').forEach(function(el) {
                    el.classList.remove('selected');
                });
            }

            if (wasSame) {
                currentSelectedId = null;
                if (window.sketchup) {
                    sketchup.toggleCircuit(idStr, false);
                } else {
                    console.log("Deselect circuit: " + id);
                }
            } else {
                currentSelectedId = idStr;
                document.querySelectorAll('[data-entity-id="' + id + '"]').forEach(function(el) {
                    el.classList.add('selected');
                });
                if (window.sketchup) {
                    sketchup.toggleCircuit(idStr, true);
                } else {
                    console.log("Select circuit: " + id);
                }
            }
        }

        // ===== Swap Mode =====
        function toggleSwapMode() {
            const btn = document.getElementById('btnSwap');
            const status = document.getElementById('swapStatus');

            if (!swapMode) {
                // --- Enter swap mode ---
                swapMode = true;
                swapSelections = [];
                btn.classList.add('active');
                updateSwapUI();
                enableSwapClicks();
            } else {
                // --- 2nd press: execute if 2 selected, otherwise cancel ---
                if (swapSelections.length === 2) {
                    const slotA = swapSelections[0];
                    const slotB = swapSelections[1];
                    status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏•‡∏±‡∏ö‡∏ß‡∏á‡∏à‡∏£ ' + slotA + ' ‚Üî ' + slotB + '...';
                    if (window.sketchup) {
                        sketchup.swapCircuits(slotA, slotB);
                    } else {
                        console.log('Swap circuits: ' + slotA + ' <-> ' + slotB);
                    }
                }
                // Exit swap mode
                swapMode = false;
                swapSelections = [];
                btn.classList.remove('active');
                btn.textContent = 'üîÑ Manual Swap';
                status.textContent = '';
                disableSwapClicks();
            }
        }

        function updateSwapUI() {
            const btn = document.getElementById('btnSwap');
            const status = document.getElementById('swapStatus');
            const count = swapSelections.length;
            btn.textContent = 'üîÑ Manual Swap (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ' + count + '/2)';
            if (count === 0) {
                status.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 1...';
            } else if (count === 1) {
                status.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏á‡∏à‡∏£ ' + swapSelections[0] + ' ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 2...';
            } else {
                status.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö 2 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ß‡∏á‡∏à‡∏£ ' + swapSelections[0] + ' ‚Üî ' + swapSelections[1] + ') ‚Üí ‡∏Å‡∏î Manual Swap ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö';
            }
        }

        function enableSwapClicks() {
            const body = document.getElementById('circuitBody');
            // Group cells by data-slot
            for (let slot = 1; slot <= MAX_ROWS * 2; slot++) {
                const cells = Array.from(body.querySelectorAll('td[data-slot="' + slot + '"]'));
                if (cells.length === 0) continue;
                cells.forEach(td => {
                    td.classList.add('swap-pick');
                    td._swapHandler = function(e) {
                        e.stopPropagation();
                        onSwapRowClick(slot, cells);
                    };
                    td.addEventListener('click', td._swapHandler);
                });
            }
        }

        function disableSwapClicks() {
            const body = document.getElementById('circuitBody');
            body.querySelectorAll('.swap-pick').forEach(td => {
                td.classList.remove('swap-pick', 'swap-selected');
                if (td._swapHandler) {
                    td.removeEventListener('click', td._swapHandler);
                    delete td._swapHandler;
                }
            });
        }

        function onSwapRowClick(slotNo, sideCells) {
            if (!swapMode) return;
            var body = document.getElementById('circuitBody');

            // Check if this slot belongs to a span group (3-phase)
            var spanGroup = sideCells.length > 0 ? sideCells[0].getAttribute('data-span-group') : null;
            var allCells = spanGroup
                ? Array.from(body.querySelectorAll('td[data-span-group="' + spanGroup + '"]'))
                : sideCells;

            // Check if this slot or its span group is already selected
            var existingIdx = swapSelections.indexOf(slotNo);
            if (existingIdx < 0 && spanGroup) {
                existingIdx = swapSelections.findIndex(function(s) {
                    return !!body.querySelector('td[data-slot="' + s + '"][data-span-group="' + spanGroup + '"]');
                });
            }

            if (existingIdx >= 0) {
                // Deselect
                swapSelections.splice(existingIdx, 1);
                allCells.forEach(function(td) { td.classList.remove('swap-selected'); });
            } else if (swapSelections.length < 2) {
                // Select
                swapSelections.push(slotNo);
                allCells.forEach(function(td) { td.classList.add('swap-selected'); });
            }
            updateSwapUI();
        }

        function doAutoBalance() {
            if (window.sketchup) {
                sketchup.autoBalance();
            } else {
                console.log('Auto Balance requested (no SketchUp connection)');
            }
        }

        function doUpdateNames() {
            if (window.sketchup) {
                sketchup.updateNames();
            } else {
                console.log('Update Names requested (no SketchUp connection)');
            }
        }

        function doSaveArrangement() {
            if (window.sketchup) {
                sketchup.saveArrangement();
            } else {
                console.log('Save Arrangement requested (no SketchUp connection)');
                onSaveComplete();
            }
        }

        function onSaveComplete() {
            var btn = document.getElementById('btnSave');
            if (btn) {
                var orig = btn.textContent;
                btn.textContent = '\u2705 \u0e1a\u0e31\u0e19\u0e17\u0e36\u0e01\u0e41\u0e25\u0e49\u0e27!';
                btn.style.background = '#4CAF50';
                btn.style.color = '#fff';
                btn.style.borderColor = '#388E3C';
                setTimeout(function() {
                    btn.textContent = orig;
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 2000);
            }
        }

        function getRandomColor() {
            const h = Math.floor(Math.random() * 360);
            const s = Math.floor(Math.random() * 30) + 70;
            const l = Math.floor(Math.random() * 25) + 20;
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        function calculateTotals(L, R) {
            let tA = 0, tB = 0, tC = 0;
            [...L, ...R].forEach(c => {
                tA += numval(c.va_a);
                tB += numval(c.va_b);
                tC += numval(c.va_c);
            });

            const fmt = v => v > 0 ? v.toLocaleString() : '-';
            document.getElementById('sumA_L').textContent = fmt(tA);
            document.getElementById('sumB_L').textContent = fmt(tB);
            document.getElementById('sumC_L').textContent = fmt(tC);
            document.getElementById('sumA_R').textContent = fmt(tA);
            document.getElementById('sumB_R').textContent = fmt(tB);
            document.getElementById('sumC_R').textContent = fmt(tC);
            document.getElementById('totalVA_A').textContent = fmt(tA);
            document.getElementById('totalVA_B').textContent = fmt(tB);
            document.getElementById('totalVA_C').textContent = fmt(tC);

            const v1p = 220;
            document.getElementById('currentA').value = tA > 0 ? (tA / v1p).toFixed(2) + ' A.' : '-';
            document.getElementById('currentB').value = tB > 0 ? (tB / v1p).toFixed(2) + ' A.' : '-';
            document.getElementById('currentC').value = tC > 0 ? (tC / v1p).toFixed(2) + ' A.' : '-';

            recalcMainBreaker();
        }

        // ===== ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏ß‡∏™‡∏ó. (EIT) - Main Breaker Calculation =====
        const EIT_BREAKER_AT = [10, 15, 16, 20, 25, 30, 32, 40, 50, 63, 75, 80, 100, 125, 150, 175, 200, 225, 250, 300, 350, 400, 500, 630, 800, 1000, 1250, 1600];
        const EIT_BREAKER_AF = [50, 100, 160, 225, 250, 400, 630, 800, 1000, 1250, 1600];
        const EIT_FEEDER_WIRE = [
            { size: 2.5, amp: 25 }, { size: 4, amp: 33 }, { size: 6, amp: 44 },
            { size: 10, amp: 61 }, { size: 16, amp: 82 }, { size: 25, amp: 108 },
            { size: 35, amp: 134 }, { size: 50, amp: 167 }, { size: 70, amp: 207 },
            { size: 95, amp: 252 }, { size: 120, amp: 290 }, { size: 150, amp: 334 },
            { size: 185, amp: 380 }, { size: 240, amp: 442 }, { size: 300, amp: 510 },
            { size: 400, amp: 607 }, { size: 500, amp: 703 }
        ];
        const EIT_CONDUIT = [
            { maxSize: 4, conduit: '1/2"' }, { maxSize: 10, conduit: '3/4"' },
            { maxSize: 16, conduit: '1"' }, { maxSize: 25, conduit: '1-1/4"' },
            { maxSize: 35, conduit: '1-1/2"' }, { maxSize: 70, conduit: '2"' },
            { maxSize: 120, conduit: '2-1/2"' }, { maxSize: 185, conduit: '3"' },
            { maxSize: 300, conduit: '4"' }, { maxSize: 500, conduit: '5"' }
        ];
        const EIT_GROUND_WIRE = [
            { maxAT: 20, size: 2.5 }, { maxAT: 40, size: 4 },
            { maxAT: 70, size: 6 }, { maxAT: 100, size: 10 },
            { maxAT: 200, size: 16 }, { maxAT: 400, size: 25 },
            { maxAT: 600, size: 35 }, { maxAT: 1600, size: 50 }
        ];

        function selectMainBreakerAT(minAmp) {
            for (const at of EIT_BREAKER_AT) { if (at >= minAmp) return at; }
            return EIT_BREAKER_AT[EIT_BREAKER_AT.length - 1];
        }
        function selectMainBreakerAF(at) {
            for (const af of EIT_BREAKER_AF) { if (af >= at) return af; }
            return EIT_BREAKER_AF[EIT_BREAKER_AF.length - 1];
        }
        function selectMainFeederWire(breakerAT) {
            for (const w of EIT_FEEDER_WIRE) { if (w.amp >= breakerAT) return w; }
            return EIT_FEEDER_WIRE[EIT_FEEDER_WIRE.length - 1];
        }
        function selectMainGroundWire(breakerAT) {
            for (const g of EIT_GROUND_WIRE) { if (breakerAT <= g.maxAT) return g.size; }
            return 50;
        }
        function selectMainConduit(wireSizeSqmm) {
            for (const c of EIT_CONDUIT) { if (wireSizeSqmm <= c.maxSize) return c.conduit + ' PVC'; }
            return '5" PVC';
        }

        function recalcMainBreaker() {
            const phase = parseInt(document.getElementById('mainPhaseSelect').value);
            const tA = numval(document.getElementById('sumA_L').textContent.replace(/,/g, ''));
            const tB = numval(document.getElementById('sumB_L').textContent.replace(/,/g, ''));
            const tC = numval(document.getElementById('sumC_L').textContent.replace(/,/g, ''));

            let totalVA, designCurrent, pole, icVoltage;

            if (phase === 1) {
                totalVA = Math.max(tA, tB, tC);
                designCurrent = totalVA / 220;
                pole = 2;
                icVoltage = '240 V.ac';
            } else {
                totalVA = tA + tB + tC;
                designCurrent = totalVA / (Math.sqrt(3) * 380);
                pole = 3;
                icVoltage = '415 V.ac';
            }

            if (designCurrent <= 0) {
                document.getElementById('designCurrent').value = '-';
                document.getElementById('mainBreakerCalc').value = '-';
                document.getElementById('mainBreakerSpec').value = '-';
                document.getElementById('feederWire').value = '-';
                document.getElementById('feederConduit').value = '-';
                return;
            }

            const minAT = designCurrent * 1.25;
            const breakerAT = selectMainBreakerAT(minAT);
            const breakerAF = selectMainBreakerAF(breakerAT);
            const feeder = selectMainFeederWire(breakerAT);
            const groundSize = selectMainGroundWire(breakerAT);
            const conduit = selectMainConduit(feeder.size);

            document.getElementById('designCurrent').value =
                designCurrent.toFixed(2) + ' A. (\u00d71.25 = ' + minAT.toFixed(2) + ' A.)';
            document.getElementById('mainBreakerCalc').value =
                pole + 'P ' + breakerAT + ' AT. ' + breakerAF + ' AF.';
            document.getElementById('mainBreakerSpec').value =
                pole + 'P ' + breakerAT + ' AT. ' + breakerAF + ' AF. IC > 25 KA ' + icVoltage;

            let wireStr;
            if (phase === 1) {
                wireStr = 'L+N : 2-1/Cx' + feeder.size + ', G : 1-1/Cx' + groundSize + ' sq.mm. (THW)';
            } else {
                wireStr = '3-1/Cx' + feeder.size + ', N : 1-1/Cx' + feeder.size + ', G : 1-1/Cx' + groundSize + ' sq.mm. (THW)';
            }
            document.getElementById('feederWire').value = wireStr;
            document.getElementById('feederConduit').value = conduit;

            if (phase === 1) {
                document.getElementById('systemType').value = '1 \u00D8 2 WIRE WITH GROUND 220 V.ac. 50 Hz';
            } else {
                document.getElementById('systemType').value = '3 \u00D8 4 WIRE WITH GROUND 380/220 V.ac. 50 Hz';
            }
        }

        function requestData() {
            if (sketchup) {
                sketchup.requestData();
            } else {
                // Sample data with 3-phase example (slots 2,4,6)
                populateTable([
                    { circuit_no: 1, name: 'LIGHTNING+SIGNAGE', wire_size: 'L+N : 2-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: 1355, va_b: '', va_c: '', span_size: 1 },
                    { circuit_no: 3, name: 'RECEPTACLE', wire_size: 'L+N : 2-1/Cx2.5\nG : 1-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: '', va_b: 1360, va_c: '', span_size: 1 },
                    { circuit_no: 5, name: 'RECEPTACLE', wire_size: 'L+N : 2-1/Cx2.5\nG : 1-1/Cx2.5', wire_type: 'THW', conduit: '1/2" PVC', breaker_pole: 1, breaker_at: 15, va_a: '', va_b: '', va_c: 1530, span_size: 1 },
                    // 3-phase circuit spanning slots 2,4,6 on right side
                    { circuit_no: 2, name: 'ELEVATOR MOTOR', wire_size: '3-1/Cx10\nG : 1-1/Cx6', wire_type: 'THW', conduit: '1" PVC', breaker_pole: 3, breaker_at: 30, va_a: 2500, va_b: '', va_c: '', span_group: '3p_elev', span_position: 0, span_size: 3 },
                    { circuit_no: 4, name: 'ELEVATOR MOTOR', wire_size: '3-1/Cx10\nG : 1-1/Cx6', wire_type: 'THW', conduit: '1" PVC', breaker_pole: 3, breaker_at: 30, va_a: '', va_b: 2500, va_c: '', span_group: '3p_elev', span_position: 1, span_size: 3 },
                    { circuit_no: 6, name: 'ELEVATOR MOTOR', wire_size: '3-1/Cx10\nG : 1-1/Cx6', wire_type: 'THW', conduit: '1" PVC', breaker_pole: 3, breaker_at: 30, va_a: '', va_b: '', va_c: 2500, span_group: '3p_elev', span_position: 2, span_size: 3 },
                    { circuit_no: 8, name: 'CDU1 (24,000 BTU)', wire_size: 'L+N : 2-1/Cx6\nG : 1-1/Cx4', wire_type: 'THW', conduit: '3/4" PVC', breaker_pole: 1, breaker_at: 30, va_a: 3000, va_b: '', va_c: '', span_size: 1 },
                ]);
            }
        }

        function exportToCSV() {
            if (sketchup) sketchup.exportCSV();
            else alert('Export CSV (\u0e17\u0e14\u0e2a\u0e2d\u0e1a - \u0e44\u0e21\u0e48\u0e44\u0e14\u0e49\u0e40\u0e0a\u0e37\u0e48\u0e2d\u0e21\u0e15\u0e48\u0e2d SketchUp)');
        }

        const COL_COUNT = 21;
        // Resizable columns: 1=SIZE L, 18=SIZE R
        const RESIZABLE_COLS = new Set([1, 18]);

        function autoFitColumns() {
            const table = document.getElementById('circuitTable');
            if (!table) return;
            const colgroup = table.querySelector('colgroup');
            if (!colgroup || colgroup.children.length < COL_COUNT) return;

            // Only clear widths for resizable columns
            const savedWidths = [];
            for (let c = 0; c < COL_COUNT; c++) {
                savedWidths[c] = colgroup.children[c].style.width;
                if (RESIZABLE_COLS.has(c)) {
                    colgroup.children[c].style.width = '';
                }
            }
            table.style.tableLayout = 'auto';
            table.style.width = 'auto';

            // Measure widths only for resizable columns
            const colWidths = new Array(COL_COUNT).fill(0);
            const allRows = table.querySelectorAll('thead tr, tbody tr, tfoot tr');
            allRows.forEach(tr => {
                let colIdx = 0;
                for (let ci = 0; ci < tr.cells.length; ci++) {
                    const td = tr.cells[ci];
                    const span = td.colSpan || 1;
                    if (span === 1 && RESIZABLE_COLS.has(colIdx) && !td.classList.contains('sld-cell')) {
                        const w = td.scrollWidth + 6;
                        if (w > colWidths[colIdx]) colWidths[colIdx] = w;
                    }
                    colIdx += span;
                }
            });

            // Apply measured widths only to resizable columns
            for (let c = 0; c < COL_COUNT; c++) {
                if (RESIZABLE_COLS.has(c)) {
                    const w = colWidths[c] > 0 ? colWidths[c] : 80;
                    colgroup.children[c].style.width = w + 'px';
                }
            }

            table.style.tableLayout = 'fixed';
            table.style.width = '100%';
        }

        function autoFit() {
            setTimeout(function () {
                autoFitColumns();
                initColumnResizers();
                initRowResizers();
            }, 300);
        }

        // ===== Column Resize (only on resizable columns) =====
        function initColumnResizers() {
            const table = document.getElementById('circuitTable');
            if (!table) return;
            const colgroup = table.querySelector('colgroup');
            if (!colgroup) return;

            // Remove old resizers
            table.querySelectorAll('.col-resizer').forEach(r => r.remove());

            // Add resizers only to header cells that cover a resizable column
            const headerRows = table.querySelectorAll('thead tr');
            headerRows.forEach(tr => {
                let colIdx = 0;
                Array.from(tr.cells).forEach(th => {
                    const myColIdx = colIdx;
                    const span = th.colSpan || 1;
                    const targetColIdx = myColIdx + span - 1;
                    colIdx += span;

                    // Only add resizer if this cell's right-edge column is resizable
                    if (!RESIZABLE_COLS.has(targetColIdx)) return;

                    const resizer = document.createElement('div');
                    resizer.className = 'col-resizer';
                    th.appendChild(resizer);

                    let startX, startW;

                    resizer.addEventListener('mousedown', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const col = colgroup.children[targetColIdx];
                        if (!col) return;
                        startX = e.pageX;
                        startW = parseInt(col.style.width) || th.offsetWidth;
                        resizer.classList.add('active');

                        function onMouseMove(ev) {
                            const diff = ev.pageX - startX;
                            const newW = Math.max(30, startW + diff);
                            col.style.width = newW + 'px';
                        }
                        function onMouseUp() {
                            resizer.classList.remove('active');
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        }
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    });

                    // Double-click to auto-fit single column
                    resizer.addEventListener('dblclick', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        autoFitSingleColumn(targetColIdx);
                    });
                });
            });
        }

        function autoFitSingleColumn(colIdx) {
            const table = document.getElementById('circuitTable');
            if (!table) return;
            const colgroup = table.querySelector('colgroup');
            if (!colgroup || !colgroup.children[colIdx]) return;
            if (!RESIZABLE_COLS.has(colIdx)) return;

            const col = colgroup.children[colIdx];
            col.style.width = '';
            table.style.tableLayout = 'auto';
            table.style.width = 'auto';

            let maxW = 0;
            const allRows = table.querySelectorAll('tr');
            allRows.forEach(tr => {
                let ci = 0;
                for (let j = 0; j < tr.cells.length; j++) {
                    const td = tr.cells[j];
                    const span = td.colSpan || 1;
                    if (ci === colIdx && span === 1) {
                        const w = td.scrollWidth + 6;
                        if (w > maxW) maxW = w;
                    }
                    ci += span;
                }
            });

            if (maxW < 30) maxW = 30;
            col.style.width = maxW + 'px';
            table.style.tableLayout = 'fixed';
            table.style.width = '100%';
        }

        // ===== Excel-like Row Height Resize =====
        function initRowResizers() {
            const table = document.getElementById('circuitTable');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            // Remove old row resizers
            tbody.querySelectorAll('.row-resizer').forEach(r => r.remove());

            const rows = tbody.querySelectorAll('tr');
            rows.forEach((tr, rowIdx) => {
                // Add resizer to the first non-rowspan cell in the row
                const firstTd = tr.cells[0];
                if (!firstTd) return;

                const resizer = document.createElement('div');
                resizer.className = 'row-resizer';
                firstTd.appendChild(resizer);

                let startY, startH;

                resizer.addEventListener('mousedown', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startY = e.pageY;
                    startH = tr.offsetHeight;
                    resizer.classList.add('active');

                    function onMouseMove(ev) {
                        const diff = ev.pageY - startY;
                        const newH = Math.max(16, startH + diff);
                        tr.style.height = newH + 'px';
                        // Also set all cells in this row
                        Array.from(tr.cells).forEach(td => {
                            td.style.height = newH + 'px';
                        });
                    }
                    function onMouseUp() {
                        resizer.classList.remove('active');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                // Double-click to auto-fit row height
                resizer.addEventListener('dblclick', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    tr.style.height = '';
                    Array.from(tr.cells).forEach(td => {
                        td.style.height = '';
                    });
                });
            });
        }

        function initHeaderResizers() {
            document.querySelectorAll('.header-info td').forEach(function(td) {
                var input = td.querySelector('input[type="text"]');
                if (!input) return;
                td.querySelectorAll('.header-resizer').forEach(function(r) { r.remove(); });
                var resizer = document.createElement('div');
                resizer.className = 'header-resizer';
                td.appendChild(resizer);
                var startX, startW;
                resizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startX = e.pageX;
                    startW = td.offsetWidth;
                    resizer.classList.add('active');
                    function onMove(ev) {
                        var diff = ev.pageX - startX;
                        var newW = Math.max(40, startW + diff);
                        td.style.width = newW + 'px';
                    }
                    function onUp() {
                        resizer.classList.remove('active');
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    }
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            requestData();
            autoFit();
            initHeaderResizers();
        });

        // Periodically save dialog position so Ruby always has the latest
        var _chromeHeight = 0;
        setTimeout(function() {
            _chromeHeight = window.outerHeight - window.innerHeight;
        }, 300);
        setInterval(function() {
            var x = window.screenX;
            var y = window.screenY - _chromeHeight;
            if (x > 0 || y > 0) {
                sketchup.savePosition(x, y);
            }
        }, 500);
    </script>

</body>

</html>